## üöÄ FinanceIQ Pro - Phase 2 Build Prompt
### Comprehensive Development Plan: Scenario Sandbox + Fund Flow Radar + Factor Exposure

---

## üéØ MISSION STATEMENT

Transform FinanceIQ Pro from "portfolio analytics tool" ‚Üí **"Bloomberg-level decision intelligence platform"**

**Core Value Proposition:**
> "Yatƒ±rƒ±mcƒ±lar sadece 'ne oldu' deƒüil, 'ne olabilir' ve 'ne yapmalƒ±yƒ±m' sorularƒ±na cevap alsƒ±n."

---

## üì¶ Phase 2 Modules (6-8 Hafta)

| Module | Priority | Time | Impact | Revenue Potential |
|--------|----------|------|--------|------------------|
| **Scenario Sandbox** | üî• HIGH | 2 hafta | üéØüéØüéØüéØ | Premium feature |
| **Fund Flow Radar** | üî• HIGH | 2-3 hafta | üéØüéØüéØüéØüéØ | Premium feature |
| **Factor Exposure Analyzer** | üü° MEDIUM | 2 hafta | üéØüéØüéØ | Premium feature |
| **Smart Alerts Engine** | üü¢ LOW | 1 hafta | üéØüéØ | Notification upsell |
| **Performance Dashboard** | üî• HIGH | 1 hafta | üéØüéØ | System health |

---

## üß© MODULE 1: Scenario Sandbox

### **Concept:**
"What-if" analizi - Kullanƒ±cƒ± makro senaryolar olu≈üturur, portf√∂y√ºne etkisini g√∂r√ºr.

### **Use Cases:**
1. **TCMB Faiz Artƒ±≈üƒ±**: "Faiz 500bp artarsa BIST %12 d√º≈üer ‚Üí Portf√∂y√ºm ne olur?"
2. **USD/TRY ≈ûoku**: "Dolar 35‚Ç∫'ye √ßƒ±karsa ‚Üí En √ßok etkilenen hisselerim?"
3. **Petrol Fiyat Artƒ±≈üƒ±**: "Petrol $120 olursa ‚Üí TUPRS, PETKM ne olur?"
4. **FED Faiz ƒ∞ndirimi**: "FED 50bp indirirse ‚Üí Teknoloji hisselerim?"

### **Data Sources:**

#### **Historical Correlations:**
```python
# TCMB Faiz vs BIST Sekt√∂rleri (2018-2024 tarihi data)
data_sources = {
    'tcmb_rates': 'TCMB API (https://evds2.tcmb.gov.tr/)',
    'bist_sectors': 'yfinance (XUSIN, XUMAL, XBANK, etc.)',
    'usd_try': 'FRED API (DEXU STR)',
    'oil_price': 'yfinance (CL=F, BZ=F)',
    'gold_price': 'yfinance (GC=F, XAUUSD=X)'
}
```

#### **Correlation Coefficients:**
```python
# √ñrnek: TCMB faiz vs BIST sekt√∂rleri
correlations = {
    'BIST_Finans': -0.68,    # Negatif korelasyon
    'BIST_Sanayi': -0.52,
    'BIST_Teknoloji': -0.45,
    'BIST_T√ºketim': -0.38,
    'USD/TRY': 0.82          # Pozitif korelasyon
}
```

### **Technical Implementation:**

#### **File:** `modules/scenario_sandbox.py`

```python
class ScenarioSandbox:
    """
    Macro scenario simulator for portfolio impact analysis
    """

    SCENARIO_TYPES = {
        'interest_rate': {
            'name': 'Faiz Oranƒ± Deƒüi≈üimi',
            'parameters': ['tcmb_change_bp', 'fed_change_bp'],
            'affected_assets': ['BIST', 'USD/TRY', 'bonds']
        },
        'currency_shock': {
            'name': 'D√∂viz Kuru ≈ûoku',
            'parameters': ['usd_try_target', 'eur_try_target'],
            'affected_assets': ['BIST_exporters', 'BIST_importers']
        },
        'commodity_price': {
            'name': 'Emtia Fiyat Deƒüi≈üimi',
            'parameters': ['oil_price_target', 'gold_price_target'],
            'affected_assets': ['energy', 'mining', 'gold']
        },
        'equity_market_shock': {
            'name': 'Piyasa ≈ûoku',
            'parameters': ['sp500_change_pct', 'bist100_change_pct'],
            'affected_assets': ['all']
        }
    }

    def __init__(self):
        self.correlation_matrix = self._load_correlations()

    def create_scenario(self, scenario_type: str, **params) -> Dict:
        """
        Create scenario and calculate expected portfolio impact

        Args:
            scenario_type: One of SCENARIO_TYPES keys
            **params: Scenario-specific parameters

        Returns:
            Dict with scenario results
        """
        pass

    def simulate_portfolio_impact(
        self,
        portfolio: pd.DataFrame,
        scenario: Dict
    ) -> pd.DataFrame:
        """
        Calculate portfolio impact based on scenario

        Uses historical correlations to estimate changes
        """
        pass

    def stress_test_portfolio(
        self,
        portfolio: pd.DataFrame,
        scenarios: List[Dict]
    ) -> pd.DataFrame:
        """
        Run multiple scenarios (best/base/worst case)
        """
        pass
```

### **UI Design:**

```python
# File: modules/scenario_sandbox_ui.py

def render_scenario_sandbox():
    st.title("üß™ Scenario Sandbox")

    # Scenario selector
    scenario_type = st.selectbox(
        "Senaryo T√ºr√º",
        options=list(ScenarioSandbox.SCENARIO_TYPES.keys()),
        format_func=lambda x: ScenarioSandbox.SCENARIO_TYPES[x]['name']
    )

    # Dynamic parameter inputs based on scenario type
    if scenario_type == 'interest_rate':
        tcmb_change = st.slider(
            "TCMB Faiz Deƒüi≈üimi (bp)",
            min_value=-500,
            max_value=1000,
            value=0,
            step=50
        )

    # Run simulation button
    if st.button("üéØ Sim√ºlasyonu √áalƒ±≈ütƒ±r"):
        sandbox = ScenarioSandbox()
        results = sandbox.simulate_portfolio_impact(portfolio, scenario)

        # Display results
        # - Portfolio value change
        # - Top winners/losers
        # - Risk metrics (VaR, Expected Shortfall)
```

### **Visualizations:**

1. **Waterfall Chart**: Portfolio value change by position
2. **Heatmap**: Sector impact matrix
3. **Gauge**: Portfolio VaR (Value at Risk)
4. **Scatter**: Risk vs Return in scenario

---

## üß© MODULE 2: Fund Flow Radar

### **Concept:**
"Paranƒ±n nereye aktƒ±ƒüƒ±nƒ± g√∂r" - TEFAS + ETF bazlƒ± para akƒ±≈üƒ± analizi.

### **Data Sources:**

#### **TEFAS (Turkish Funds):**
```python
# TEFAS API/Scraping
url = "https://www.tefas.gov.tr/api/DB/BindHistoryAllocation"
params = {
    'fontip': 'YAT',  # YAT = Hisse Fonlarƒ±
    'sfontur': '',
    'bastarih': '2024-01-01',
    'bittarih': '2024-12-31'
}

# Parse response ‚Üí daily fund sizes
# Calculate: Net Flow = Size_today - Size_yesterday - (Return% * Size_yesterday)
```

#### **US ETFs:**
```python
# Use existing ETF Weight Tracker data
# Aggregate by sector
```

### **Technical Implementation:**

#### **File:** `modules/fund_flow_radar.py`

```python
class FundFlowRadar:
    """
    Track money flows into/out of funds and sectors
    """

    def fetch_tefas_flows(self, start_date: str, end_date: str) -> pd.DataFrame:
        """Fetch daily TEFAS fund sizes"""
        pass

    def calculate_net_flows(self, fund_sizes: pd.DataFrame) -> pd.DataFrame:
        """
        Calculate net flows (excluding performance)

        Flow = AUM_t - AUM_{t-1} - (Return_{t-1} * AUM_{t-1})
        """
        pass

    def aggregate_sector_flows(
        self,
        flows: pd.DataFrame,
        period: str = '7d'
    ) -> pd.DataFrame:
        """
        Aggregate flows by sector

        Returns:
            sector, net_flow, num_funds, avg_flow
        """
        pass

    def create_flow_sankey(self, flows: pd.DataFrame) -> go.Figure:
        """
        Sankey diagram: Source ‚Üí Sectors ‚Üí Funds

        Layers:
        1. Yatƒ±rƒ±mcƒ±lar (Source)
        2. Sekt√∂rler (Middle)
        3. Fonlar (Target)
        """
        pass

    def detect_flow_anomalies(
        self,
        flows: pd.DataFrame,
        threshold: float = 2.0
    ) -> List[Dict]:
        """
        Detect unusual flow patterns (>2 std dev)
        """
        pass
```

### **UI Design:**

```python
def render_fund_flow_radar():
    st.title("üì° Fund Flow Radar")

    # Period selector
    period = st.selectbox(
        "Analiz D√∂nemi",
        options=['7d', '30d', '90d', 'ytd'],
        format_func=lambda x: {
            '7d': 'Son 7 G√ºn',
            '30d': 'Son 30 G√ºn',
            '90d': 'Son 3 Ay',
            'ytd': 'Yƒ±l Ba≈üƒ±ndan Beri'
        }[x]
    )

    # Calculate flows
    radar = FundFlowRadar()
    flows = radar.aggregate_sector_flows(period=period)

    # Display top gainers/losers
    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### ‚¨ÜÔ∏è En √áok Para Giren Sekt√∂rler")
        top_inflows = flows.nlargest(5, 'net_flow')
        # Display bar chart + table

    with col2:
        st.markdown("### ‚¨áÔ∏è En √áok Para √áƒ±kan Sekt√∂rler")
        top_outflows = flows.nsmallest(5, 'net_flow')
        # Display bar chart + table

    # Sankey diagram
    st.markdown("### üîÄ Para Akƒ±≈üƒ± Haritasƒ±")
    fig_sankey = radar.create_flow_sankey(flows)
    st.plotly_chart(fig_sankey)

    # Insights
    st.markdown("### üí° Sinyal ve Yorumlar")
    # Auto-generate insights using InsightEngine
```

### **Visualizations:**

1. **Sankey Diagram**: Money flow (Investors ‚Üí Sectors ‚Üí Funds)
2. **Bar Chart**: Top inflow/outflow sectors
3. **Heatmap**: Flow intensity by sector + time
4. **Time Series**: Cumulative flows over time

---

## üß© MODULE 3: Factor Exposure Analyzer

### **Concept:**
"Portf√∂y√ºn fakt√∂r risklerini √∂l√ß" - Profesyonel fon y√∂neticilerinin kullandƒ±ƒüƒ± analiz.

### **Factors:**

1. **Value** - P/B, P/E d√º≈ü√ºk hisseler
2. **Growth** - Revenue/Earnings growth y√ºksek
3. **Momentum** - Son 6-12 ay performans
4. **Volatility** - Risk/Beta
5. **Size** - Market cap (small vs large)
6. **Quality** - ROE, Debt/Equity

### **Technical Implementation:**

#### **File:** `modules/factor_exposure.py`

```python
class FactorExposureAnalyzer:
    """
    Calculate portfolio factor exposures

    Based on Fama-French factor models
    """

    FACTORS = {
        'value': {
            'metrics': ['pb_ratio', 'pe_ratio', 'ps_ratio'],
            'ideal_range': (0, 15),  # Low P/E = high value
            'weight': 'inverse'  # Lower is better
        },
        'growth': {
            'metrics': ['revenue_growth', 'earnings_growth'],
            'ideal_range': (15, 50),  # High growth
            'weight': 'direct'
        },
        'momentum': {
            'metrics': ['return_6m', 'return_12m'],
            'ideal_range': (10, 50),
            'weight': 'direct'
        },
        'volatility': {
            'metrics': ['beta', 'std_dev'],
            'ideal_range': (0.8, 1.2),
            'weight': 'inverse'
        },
        'size': {
            'metrics': ['market_cap'],
            'ideal_range': (10e9, 100e9),  # Mid-cap
            'weight': 'neutral'
        },
        'quality': {
            'metrics': ['roe', 'debt_to_equity'],
            'ideal_range': (15, 25),  # High ROE
            'weight': 'direct'
        }
    }

    def calculate_factor_scores(
        self,
        portfolio: pd.DataFrame
    ) -> pd.DataFrame:
        """
        Calculate factor scores for each stock

        Returns:
            DataFrame with factor scores (0-100)
        """
        pass

    def calculate_portfolio_exposure(
        self,
        portfolio: pd.DataFrame
    ) -> Dict:
        """
        Calculate weighted portfolio factor exposure

        Returns:
            {factor: score, concentration: pct}
        """
        pass

    def factor_attribution(
        self,
        portfolio: pd.DataFrame,
        returns: pd.Series
    ) -> Dict:
        """
        Attribute portfolio returns to factors

        Example:
        - Momentum factor contributed +4.5%
        - Value factor contributed +2.0%
        - Other: +1.5%
        """
        pass

    def recommend_factor_balance(
        self,
        current_exposure: Dict
    ) -> List[str]:
        """
        Generate recommendations to balance factors
        """
        pass
```

### **UI Design:**

```python
def render_factor_exposure():
    st.title("üìä Factor Exposure Analyzer")

    # Calculate exposures
    analyzer = FactorExposureAnalyzer()
    exposure = analyzer.calculate_portfolio_exposure(portfolio)

    # Radar chart
    st.markdown("### üï∏Ô∏è Fakt√∂r Daƒüƒ±lƒ±mƒ±")
    fig_radar = create_factor_radar_chart(exposure)
    st.plotly_chart(fig_radar)

    # Factor breakdown
    for factor, score in exposure.items():
        col1, col2 = st.columns([1, 3])

        with col1:
            st.metric(factor.capitalize(), f"{score:.1f}/100")

        with col2:
            progress_bar(score / 100)
            if score > 70:
                st.success(f"Y√ºksek {factor} exposure")
            elif score < 30:
                st.warning(f"D√º≈ü√ºk {factor} exposure")

    # Recommendations
    recs = analyzer.recommend_factor_balance(exposure)
    st.markdown("### üí° √ñneriler")
    for rec in recs:
        st.info(rec)
```

---

## üß© MODULE 4: Smart Alerts Engine

### **Concept:**
Proaktif bildirimler - Sadece fiyat deƒüil, davranƒ±≈ü sinyali.

### **Alert Types:**

1. **Portfolio Alerts:**
   - "3 hisseniz endekse g√∂re underperform ediyor"
   - "Portf√∂y saƒülƒ±k skoru 70'in altƒ±na d√º≈üt√º"
   - "Top pozisyonunuz %30'u ge√ßti"

2. **ETF Weight Alerts:**
   - "QQQ'da NVDA aƒüƒ±rlƒ±ƒüƒ± %2 arttƒ±"
   - "SPY'dan AAPL aƒüƒ±rlƒ±ƒüƒ± azaltƒ±ldƒ±"

3. **Fund Flow Alerts:**
   - "Teknoloji fonlarƒ±na 3 g√ºnde ‚Ç∫500M giri≈ü"
   - "Finans fonlarƒ±ndan hƒ±zlƒ± √ßƒ±kƒ±≈ü var"

4. **Technical Alerts:**
   - "ASELS 50-day MA'yƒ± yukarƒ± kesti"
   - "THYAO RSI 30'un altƒ±nda (oversold)"

### **Delivery Channels:**

- **In-App:** Streamlit notification (st.toast)
- **Email:** SMTP (Gmail, SendGrid)
- **WhatsApp:** Twilio API
- **Telegram:** Telegram Bot API

---

## üß© MODULE 5: Performance Dashboard

### **Concept:**
System health + usage analytics.

### **Metrics Tracked:**

1. **Data Health:**
   - Last update time
   - Data coverage (%)
   - API status (yfinance, TEFAS)

2. **Usage Analytics:**
   - Most viewed stocks/ETFs
   - Average portfolio health score
   - Popular scenarios

3. **System Performance:**
   - Cache hit rate
   - Avg response time
   - Error rate

### **UI Design:**

```python
def render_performance_dashboard():
    st.title("‚öôÔ∏è System Performance")

    # Data health
    col1, col2, col3 = st.columns(3)

    with col1:
        st.metric("Veri G√ºncellik", "2 saat √∂nce", delta="‚úÖ")

    with col2:
        st.metric("ETF Kapsama", "92%", delta="+5%")

    with col3:
        st.metric("API Durumu", "√áalƒ±≈üƒ±yor", delta="‚úÖ")

    # Most viewed assets
    st.markdown("### üìä En Pop√ºler Hisseler")
    # Display bar chart

    # Average health scores
    st.markdown("### üìà Ortalama Health Score Daƒüƒ±lƒ±mƒ±")
    # Display histogram
```

---

## üìÖ 6-WEEK IMPLEMENTATION TIMELINE

### **Week 1-2: Scenario Sandbox** üß™
- [ ] Day 1-2: Data collection (TCMB, BIST correlations)
- [ ] Day 3-5: Scenario engine implementation
- [ ] Day 6-8: UI development
- [ ] Day 9-10: Testing + insights integration
- [ ] Day 11-14: Polish + documentation

### **Week 3-5: Fund Flow Radar** üì°
- [ ] Day 1-3: TEFAS API/scraper
- [ ] Day 4-6: Flow calculation engine
- [ ] Day 7-10: Sankey visualization
- [ ] Day 11-14: Sector aggregation
- [ ] Day 15-18: Alert system integration
- [ ] Day 19-21: Testing + polish

### **Week 6: Factor Exposure + Polish** üìä
- [ ] Day 1-4: Factor calculation engine
- [ ] Day 5-7: UI + visualizations
- [ ] Day 8-10: Integration testing
- [ ] Day 11-14: Bug fixes + deployment prep

---

## üéØ SUCCESS METRICS

### **Technical:**
- ‚úÖ 3 new major modules
- ‚úÖ 1,500+ lines of production code
- ‚úÖ Test coverage >80%
- ‚úÖ Performance: <3 sec response time

### **User Experience:**
- ‚úÖ 5+ new visualizations
- ‚úÖ 20+ new insights
- ‚úÖ Actionable alerts
- ‚úÖ Mobile-friendly UI

### **Business:**
- ‚úÖ Premium feature differentiation
- ‚úÖ User engagement +50%
- ‚úÖ Avg session time +3 min
- ‚úÖ Conversion funnel ready

---

## üí∞ MONETIZATION STRATEGY

### **Free Tier:**
- Portfolio Health Score (basic)
- ETF Tracker (limited stocks)
- 3 scenarios/month
- No alerts

### **Premium Tier - ‚Ç∫149/ay ($5/mo):**
- ‚úÖ Unlimited scenarios
- ‚úÖ Fund Flow Radar (real-time)
- ‚úÖ Factor Exposure Analyzer
- ‚úÖ Smart Alerts (WhatsApp/Email)
- ‚úÖ Historical data (12 months)
- ‚úÖ Export unlimited

### **Pro Tier - ‚Ç∫299/ay ($10/mo):**
- ‚úÖ All Premium features
- ‚úÖ API access
- ‚úÖ Custom alerts
- ‚úÖ Priority support
- ‚úÖ Advanced scenarios (custom correlations)

---

## üöÄ NEXT STEPS

**Immediate (This Week):**
1. Set up TEFAS data pipeline
2. Build correlation matrix (TCMB/BIST)
3. Create scenario engine skeleton

**Month 1:**
1. Complete Scenario Sandbox
2. Start Fund Flow Radar
3. Launch beta testing (50 users)

**Month 2:**
1. Complete Fund Flow Radar
2. Add Factor Exposure
3. Launch premium tier
4. Target: 100 paying users

---

**Ready to start coding? Say the word and I'll generate the first module!** üöÄ
