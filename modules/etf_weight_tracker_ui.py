"""
ETF Holdings Weight Tracker - Streamlit UI
Bloomberg-level ETF holdings analysis interface
"""

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
from modules.etf_weight_tracker import ETFWeightTracker
from modules.insight_engine import generate_all_insights
from datetime import datetime
import numpy as np
import warnings
warnings.filterwarnings('ignore')


class ETFWeightTrackerUI:
    """Streamlit UI for ETF Weight Tracker"""

    def __init__(self):
        self.tracker = ETFWeightTracker()

    def render(self):
        """Main render function"""
        st.title("üìä ETF Holdings Weight Tracker")
        st.markdown("""
        **Bloomberg Terminal seviyesinde ETF analizi** - Hangi fonlarda hangi hisseler var?
        Aƒüƒ±rlƒ±k deƒüi≈üimlerini takip edin ve fon y√∂neticilerinin sinyallerini yakalayƒ±n.
        """)

        # Tabs for different analyses
        tab1, tab2, tab3, tab4 = st.tabs([
            "üîç Hisse Analizi",
            "üìà Aƒüƒ±rlƒ±k Ge√ßmi≈üi",
            "üéØ Fon Y√∂neticisi Sinyalleri",
            "‚öôÔ∏è Veri Y√∂netimi"
        ])

        with tab1:
            self._render_stock_lookup()

        with tab2:
            self._render_weight_history()

        with tab3:
            self._render_manager_signals()

        with tab4:
            self._render_data_management()

    def _render_stock_lookup(self):
        """Stock lookup interface - reverse search"""
        st.subheader("üîç Hisse Analizi: Bu Hisse Hangi Fonlarda?")

        col1, col2 = st.columns([2, 1])

        with col1:
            stock_symbol = st.text_input(
                "Hisse Sembol√º",
                value="AAPL",
                help="√ñrnek: AAPL, MSFT, GOOGL, TSLA"
            ).upper()

        with col2:
            min_weight = st.slider(
                "Min Aƒüƒ±rlƒ±k (%)",
                min_value=0.1,
                max_value=10.0,
                value=1.0,
                step=0.1,
                help="Sadece bu aƒüƒ±rlƒ±ƒüƒ±n √ºzerindeki fonlarƒ± g√∂ster"
            )

        if st.button("üîç Analiz Et", type="primary", use_container_width=True, key="etf_weight_tracker___analiz_et"):
            with st.spinner(f"{stock_symbol} i√ßin fon taramasƒ± yapƒ±lƒ±yor..."):
                self._display_stock_analysis(stock_symbol, min_weight)

    def _display_stock_analysis(self, stock_symbol: str, min_weight: float):
        """Display comprehensive stock analysis"""
        # Get funds holding this stock
        holdings_df = self.tracker.get_funds_for_stock(stock_symbol, min_weight)

        if len(holdings_df) == 0:
            st.warning(f"‚ö†Ô∏è {stock_symbol} i√ßin veri bulunamadƒ±. Veri tabanƒ±nƒ± g√ºncelleyin (Veri Y√∂netimi sekmesi).")
            return

        # Summary metrics
        st.markdown("---")
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric("Toplam Fon", len(holdings_df))

        with col2:
            max_weight = holdings_df['weight_pct'].max()
            max_fund = holdings_df.loc[holdings_df['weight_pct'].idxmax(), 'fund_code']
            st.metric("En Y√ºksek Aƒüƒ±rlƒ±k", f"{max_weight:.2f}%", delta=max_fund)

        with col3:
            avg_weight = holdings_df['weight_pct'].mean()
            st.metric("Ortalama Aƒüƒ±rlƒ±k", f"{avg_weight:.2f}%")

        with col4:
            latest_date = holdings_df['report_date'].max()
            st.metric("Son G√ºncelleme", latest_date)

        # Holdings table
        st.markdown("### üìã Fon Listesi")

        display_df = holdings_df[['fund_code', 'fund_name', 'weight_pct', 'report_date']].copy()
        display_df.columns = ['Fon Kodu', 'Fon Adƒ±', 'Aƒüƒ±rlƒ±k (%)', 'Rapor Tarihi']
        display_df = display_df.sort_values('Aƒüƒ±rlƒ±k (%)', ascending=False)

        st.dataframe(
            display_df,
            use_container_width=True,
            height=400,
            hide_index=True
        )

        # Visualization
        col1, col2 = st.columns(2)

        with col1:
            # Bar chart
            fig_bar = px.bar(
                holdings_df.nlargest(15, 'weight_pct'),
                x='weight_pct',
                y='fund_code',
                orientation='h',
                title=f'{stock_symbol} - Fon Aƒüƒ±rlƒ±klarƒ± (Top 15)',
                labels={'weight_pct': 'Aƒüƒ±rlƒ±k (%)', 'fund_code': 'Fon'},
                color='weight_pct',
                color_continuous_scale='Blues'
            )
            fig_bar.update_layout(showlegend=False, height=500)
            st.plotly_chart(fig_bar, use_container_width=True)

        with col2:
            # Treemap
            fig_tree = px.treemap(
                holdings_df.nlargest(20, 'weight_pct'),
                path=['fund_code'],
                values='weight_pct',
                title=f'{stock_symbol} - Aƒüƒ±rlƒ±k Daƒüƒ±lƒ±mƒ± (Treemap)',
                color='weight_pct',
                color_continuous_scale='RdYlGn'
            )
            fig_tree.update_layout(height=500)
            st.plotly_chart(fig_tree, use_container_width=True)

        # Fund manager action detection
        st.markdown("### üéØ Fon Y√∂neticisi Sinyali")
        action_signal = self.tracker.detect_fund_manager_actions(stock_symbol)

        signal_color = {
            'BULLISH': 'üü¢',
            'BEARISH': 'üî¥',
            'NEUTRAL': '‚ö™'
        }

        col1, col2, col3 = st.columns(3)

        with col1:
            st.markdown(f"### {signal_color.get(action_signal['signal'], '‚ö™')} {action_signal['signal']}")

        with col2:
            st.metric("G√ºven Skoru", f"{action_signal['confidence']:.1f}%")

        with col3:
            st.info(action_signal['details'])

        # Detailed breakdown
        if action_signal['total_funds'] > 0:
            with st.expander("üìä Detaylƒ± Analiz"):
                st.markdown(f"""
                **Son 30 G√ºnl√ºk Hareketler:**
                - ‚¨ÜÔ∏è Aƒüƒ±rlƒ±k Artƒ±≈üƒ±: {action_signal['increases']} fon
                - ‚¨áÔ∏è Aƒüƒ±rlƒ±k Azalƒ±≈üƒ±: {action_signal['decreases']} fon
                - Toplam Fon: {action_signal['total_funds']}

                **Yorum:**
                """)

                if action_signal['signal'] == 'BULLISH':
                    st.success(f"""
                    Fonlarƒ±n √ßoƒüunluƒüu ({action_signal['increases']}/{action_signal['total_funds']})
                    {stock_symbol} aƒüƒ±rlƒ±ƒüƒ±nƒ± artƒ±rmƒ±≈ü. Bu genelde **pozitif sinyal** olarak yorumlanƒ±r.
                    Kurumsal yatƒ±rƒ±mcƒ±lar bu hisseyi biriktiriyor olabilir.
                    """)
                elif action_signal['signal'] == 'BEARISH':
                    st.warning(f"""
                    Fonlarƒ±n √ßoƒüunluƒüu ({action_signal['decreases']}/{action_signal['total_funds']})
                    {stock_symbol} aƒüƒ±rlƒ±ƒüƒ±nƒ± azaltmƒ±≈ü. Bu **negatif sinyal** olabilir.
                    Kurumsal yatƒ±rƒ±mcƒ±lar pozisyon azaltƒ±yor.
                    """)
                else:
                    st.info("""
                    Karƒ±≈üƒ±k sinyaller var. Bazƒ± fonlar alƒ±yor, bazƒ±larƒ± satƒ±yor.
                    Net bir trend yok. Daha fazla veri i√ßin bekleyin.
                    """)

        # AI-Powered Insights
        st.markdown("---")
        st.subheader("ü§ñ AI ƒ∞√ßg√∂r√ºler")

        try:
            insights = generate_all_insights(
                data_type='etf',
                stock_symbol=stock_symbol,
                holdings_df=holdings_df,
                action_signal=action_signal
            )

            if insights:
                for insight in insights:
                    if insight.startswith("üü¢"):
                        st.success(insight)
                    elif insight.startswith("‚ö†Ô∏è") or insight.startswith("üü°"):
                        st.warning(insight)
                    elif insight.startswith("üî¥"):
                        st.error(insight)
                    else:
                        st.info(insight)
            else:
                st.info("‚ÑπÔ∏è ≈ûu anda ek i√ßg√∂r√º bulunmuyor.")

        except Exception as e:
            st.warning(f"‚ö†Ô∏è ƒ∞√ßg√∂r√ºler y√ºklenirken hata: {e}")

    def _render_weight_history(self):
        """Weight history tracking interface"""
        st.subheader("üìà Aƒüƒ±rlƒ±k Ge√ßmi≈üi ve Trend Analizi")

        col1, col2 = st.columns(2)

        with col1:
            stock_symbol = st.text_input(
                "Hisse Sembol√º",
                value="NVDA",
                key="weight_history_stock"
            ).upper()

        with col2:
            # Get available funds for this stock
            available_funds = self.tracker.get_funds_for_stock(stock_symbol, min_weight=0.1)

            if len(available_funds) > 0:
                fund_options = available_funds['fund_code'].tolist()
                fund_code = st.selectbox(
                    "Fon Se√ßin",
                    options=fund_options,
                    key="weight_history_fund"
                )
            else:
                st.warning("Bu hisse i√ßin veri bulunamadƒ±")
                fund_code = None

        if fund_code and st.button("üìä Ge√ßmi≈üi G√∂ster", type="primary", use_container_width=True, key="etf_weight_tracker___ge_mi_i_g_ster"):
            with st.spinner("Tarihsel veriler y√ºkleniyor..."):
                self._display_weight_history(stock_symbol, fund_code)

    def _display_weight_history(self, stock_symbol: str, fund_code: str):
        """Display weight history chart"""
        history_df = self.tracker.get_weight_history(stock_symbol, fund_code)

        if len(history_df) == 0:
            st.warning("Bu hisse-fon kombinasyonu i√ßin ge√ßmi≈ü veri yok.")
            return

        st.markdown("---")

        # Summary stats
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            current_weight = history_df['weight_pct'].iloc[-1]
            st.metric("Mevcut Aƒüƒ±rlƒ±k", f"{current_weight:.2f}%")

        with col2:
            if len(history_df) > 1:
                weight_change = history_df['weight_change'].iloc[-1]
                st.metric("Son Deƒüi≈üim", f"{weight_change:+.2f}%")
            else:
                st.metric("Son Deƒüi≈üim", "N/A")

        with col3:
            max_weight = history_df['weight_pct'].max()
            st.metric("Maksimum Aƒüƒ±rlƒ±k", f"{max_weight:.2f}%")

        with col4:
            min_weight = history_df['weight_pct'].min()
            st.metric("Minimum Aƒüƒ±rlƒ±k", f"{min_weight:.2f}%")

        # Line chart
        fig = go.Figure()

        fig.add_trace(go.Scatter(
            x=history_df['report_date'],
            y=history_df['weight_pct'],
            mode='lines+markers',
            name='Aƒüƒ±rlƒ±k (%)',
            line=dict(color='#1f77b4', width=3),
            marker=dict(size=8),
            hovertemplate='<b>Tarih:</b> %{x}<br><b>Aƒüƒ±rlƒ±k:</b> %{y:.2f}%<extra></extra>'
        ))

        # Add trend line if enough data points
        if len(history_df) >= 3:
            z = np.polyfit(range(len(history_df)), history_df['weight_pct'], 1)
            p = np.poly1d(z)
            trend = p(range(len(history_df)))

            fig.add_trace(go.Scatter(
                x=history_df['report_date'],
                y=trend,
                mode='lines',
                name='Trend',
                line=dict(color='red', width=2, dash='dash'),
                hovertemplate='<b>Trend:</b> %{y:.2f}%<extra></extra>'
            ))

        fig.update_layout(
            title=f'{stock_symbol} Aƒüƒ±rlƒ±k Ge√ßmi≈üi - {fund_code}',
            xaxis_title='Tarih',
            yaxis_title='Aƒüƒ±rlƒ±k (%)',
            hovermode='x unified',
            height=500
        )

        st.plotly_chart(fig, use_container_width=True)

        # Weight change table
        st.markdown("### üìã Aƒüƒ±rlƒ±k Deƒüi≈üim Tablosu")

        display_df = history_df[['report_date', 'weight_pct', 'weight_change']].copy()
        display_df.columns = ['Tarih', 'Aƒüƒ±rlƒ±k (%)', 'Deƒüi≈üim (%)']
        display_df['Deƒüi≈üim (%)'] = display_df['Deƒüi≈üim (%)'].apply(
            lambda x: f"{x:+.2f}" if pd.notna(x) else "N/A"
        )

        st.dataframe(display_df, use_container_width=True, hide_index=True)

        # Trend interpretation
        if len(history_df) >= 3:
            trend_slope = z[0]  # Slope of trend line

            with st.expander("üîç Trend Yorumu"):
                if trend_slope > 0.5:
                    st.success(f"""
                    ‚úÖ **Y√ºkselen Trend**

                    {fund_code} fonunda {stock_symbol} aƒüƒ±rlƒ±ƒüƒ± artƒ±≈ü trendinde.
                    Fon y√∂neticisi bu hisseyi s√ºrekli artƒ±rƒ±yor.

                    **Yorum:** Genelde pozitif sinyal. Kurumsal yatƒ±rƒ±mcƒ±lar bu hisseyi tercih ediyor.
                    """)
                elif trend_slope < -0.5:
                    st.warning(f"""
                    ‚ö†Ô∏è **D√º≈üen Trend**

                    {fund_code} fonunda {stock_symbol} aƒüƒ±rlƒ±ƒüƒ± azalƒ±≈ü trendinde.
                    Fon y√∂neticisi pozisyon azaltƒ±yor.

                    **Yorum:** Negatif sinyal olabilir. Kurumsal yatƒ±rƒ±mcƒ±lar √ßƒ±kƒ±≈ü yapƒ±yor.
                    """)
                else:
                    st.info(f"""
                    ‚ö™ **Yatay Trend**

                    {fund_code} fonunda {stock_symbol} aƒüƒ±rlƒ±ƒüƒ± stabil.
                    Fon y√∂neticisi pozisyonu koruyor.

                    **Yorum:** N√∂tr. √ñnemli bir deƒüi≈üiklik yok.
                    """)

        # AI-Powered Insights for Weight History
        st.markdown("---")
        st.subheader("ü§ñ AI Trend ƒ∞√ßg√∂r√ºleri")

        try:
            insights = generate_all_insights(
                data_type='weight_history',
                stock_symbol=stock_symbol,
                history_df=history_df,
                fund_code=fund_code
            )

            if insights:
                for insight in insights:
                    if insight.startswith("üìà") or insight.startswith("üü¢"):
                        st.success(insight)
                    elif insight.startswith("üìâ") or insight.startswith("‚ö†Ô∏è"):
                        st.warning(insight)
                    elif insight.startswith("‚ö°"):
                        st.info(insight)
                    else:
                        st.info(insight)
            else:
                st.info("‚ÑπÔ∏è ≈ûu anda trend analizi i√ßin yetersiz veri.")

        except Exception as e:
            st.warning(f"‚ö†Ô∏è ƒ∞√ßg√∂r√ºler y√ºklenirken hata: {e}")

    def _render_manager_signals(self):
        """Fund manager action signals"""
        st.subheader("üéØ Fon Y√∂neticisi Sinyalleri")
        st.markdown("""
        Son 30 g√ºnde aƒüƒ±rlƒ±ƒüƒ± en √ßok deƒüi≈üen hisseleri g√∂r√ºn.
        Kurumsal yatƒ±rƒ±mcƒ±larƒ±n hangi hisseleri biriktirdiƒüini/sattƒ±ƒüƒ±nƒ± ke≈üfedin.
        """)

        if st.button("üîç En Aktif Hisseleri Bul", type="primary", use_container_width=True, key="etf_weight_tracker___en_aktif_hisseleri_bul"):
            with st.spinner("Fon hareketleri analiz ediliyor..."):
                self._display_top_changes()

    def _display_top_changes(self):
        """Display stocks with biggest weight changes"""
        changes_df = self.tracker.get_top_weight_changes(period_days=30, limit=30)

        if len(changes_df) == 0:
            st.warning("‚ö†Ô∏è Yeterli veri yok. L√ºtfen veri tabanƒ±nƒ± g√ºncelleyin.")
            return

        st.markdown("---")

        # Separate into increases and decreases
        increases = changes_df[changes_df['avg_weight_change'] > 0].nlargest(10, 'avg_weight_change')
        decreases = changes_df[changes_df['avg_weight_change'] < 0].nsmallest(10, 'avg_weight_change')

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("### ‚¨ÜÔ∏è En √áok Aƒüƒ±rlƒ±k Artan Hisseler")

            if len(increases) > 0:
                fig_inc = px.bar(
                    increases,
                    x='avg_weight_change',
                    y='stock_symbol',
                    orientation='h',
                    color='funds_increased',
                    title='Aƒüƒ±rlƒ±k Artƒ±≈üƒ± (Son 30 G√ºn)',
                    labels={
                        'avg_weight_change': 'Ortalama Deƒüi≈üim (%)',
                        'stock_symbol': 'Hisse',
                        'funds_increased': 'Artƒ±≈ü Yapan Fon Sayƒ±sƒ±'
                    },
                    color_continuous_scale='Greens'
                )
                fig_inc.update_layout(height=500)
                st.plotly_chart(fig_inc, use_container_width=True)

                st.dataframe(
                    increases[['stock_symbol', 'num_funds_changed', 'avg_weight_change', 'funds_increased']],
                    use_container_width=True,
                    hide_index=True,
                    column_config={
                        'stock_symbol': 'Hisse',
                        'num_funds_changed': 'Deƒüi≈üen Fon Sayƒ±sƒ±',
                        'avg_weight_change': 'Ort. Deƒüi≈üim (%)',
                        'funds_increased': 'Artƒ±≈ü Yapan Fon'
                    }
                )
            else:
                st.info("Son 30 g√ºnde aƒüƒ±rlƒ±k artƒ±≈üƒ± yok.")

        with col2:
            st.markdown("### ‚¨áÔ∏è En √áok Aƒüƒ±rlƒ±k Azalan Hisseler")

            if len(decreases) > 0:
                fig_dec = px.bar(
                    decreases,
                    x='avg_weight_change',
                    y='stock_symbol',
                    orientation='h',
                    color='funds_decreased',
                    title='Aƒüƒ±rlƒ±k Azalƒ±≈üƒ± (Son 30 G√ºn)',
                    labels={
                        'avg_weight_change': 'Ortalama Deƒüi≈üim (%)',
                        'stock_symbol': 'Hisse',
                        'funds_decreased': 'Azalƒ±≈ü Yapan Fon Sayƒ±sƒ±'
                    },
                    color_continuous_scale='Reds'
                )
                fig_dec.update_layout(height=500)
                st.plotly_chart(fig_dec, use_container_width=True)

                st.dataframe(
                    decreases[['stock_symbol', 'num_funds_changed', 'avg_weight_change', 'funds_decreased']],
                    use_container_width=True,
                    hide_index=True,
                    column_config={
                        'stock_symbol': 'Hisse',
                        'num_funds_changed': 'Deƒüi≈üen Fon Sayƒ±sƒ±',
                        'avg_weight_change': 'Ort. Deƒüi≈üim (%)',
                        'funds_decreased': 'Azalƒ±≈ü Yapan Fon'
                    }
                )
            else:
                st.info("Son 30 g√ºnde aƒüƒ±rlƒ±k azalƒ±≈üƒ± yok.")

    def _render_data_management(self):
        """Data management interface"""
        st.subheader("‚öôÔ∏è Veri Y√∂netimi")

        # Database stats
        stats = self.tracker.get_summary_stats()

        st.markdown("### üìä Veri Tabanƒ± ƒ∞statistikleri")

        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric("Toplam Kayƒ±t", f"{stats['total_records']:,}")

        with col2:
            st.metric("Benzersiz Hisse", stats['unique_stocks'])

        with col3:
            st.metric("Benzersiz Fon", stats['unique_funds'])

        with col4:
            st.metric("Son G√ºncelleme", stats['latest_update'])

        # ETF data fetching
        st.markdown("---")
        st.markdown("### üîÑ ETF Verilerini G√ºncelle")

        col1, col2 = st.columns([2, 1])

        with col1:
            etf_options = list(self.tracker.TRACKED_ETFS.keys())
            selected_etfs = st.multiselect(
                "G√ºncellenecek ETF'leri Se√ßin",
                options=['T√úM√ú'] + etf_options,
                default=['T√úM√ú'],
                help="T√úM√ú se√ßeneƒüi t√ºm ETF'leri g√ºnceller (uzun s√ºrebilir)"
            )

        with col2:
            force_refresh = st.checkbox(
                "Zorla Yenile",
                value=False,
                help="Cache'i atla ve API'den tekrar √ßek"
            )

        if st.button("üöÄ Verileri G√ºncelle", type="primary", use_container_width=True, key="etf_weight_tracker___verileri_g_ncelle"):
            if 'T√úM√ú' in selected_etfs:
                etf_list = None  # Will fetch all
                st.info(f"T√ºm ETF'ler g√ºncelleniyor... Bu 5-10 dakika s√ºrebilir.")
            else:
                etf_list = selected_etfs

            with st.spinner("Veriler √ßekiliyor... L√ºtfen bekleyin."):
                results = self.tracker.bulk_fetch_etf_holdings(etf_list, force_refresh=force_refresh)

                # Display results
                success_count = sum(1 for r in results.values() if r['success'])
                fail_count = len(results) - success_count

                st.success(f"‚úÖ {success_count} ETF ba≈üarƒ±yla g√ºncellendi")

                if fail_count > 0:
                    st.warning(f"‚ö†Ô∏è {fail_count} ETF g√ºncellenemedi")

                # Detailed results
                with st.expander("üìã Detaylƒ± Sonu√ßlar"):
                    results_df = pd.DataFrame([
                        {
                            'ETF': etf,
                            'Durum': '‚úÖ Ba≈üarƒ±lƒ±' if data['success'] else '‚ùå Ba≈üarƒ±sƒ±z',
                            'Holding Sayƒ±sƒ±': data.get('num_holdings', 'N/A'),
                            'En B√ºy√ºk Holding': data.get('top_holding', 'N/A')
                        }
                        for etf, data in results.items()
                    ])

                    st.dataframe(results_df, use_container_width=True, hide_index=True)

        # Tracked ETFs list
        with st.expander("üìã Takip Edilen ETF Listesi"):
            etf_list_df = pd.DataFrame([
                {'Kod': code, 'Ad': name}
                for code, name in self.tracker.TRACKED_ETFS.items()
            ])
            st.dataframe(etf_list_df, use_container_width=True, hide_index=True, height=400)
